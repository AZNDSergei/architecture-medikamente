## Движок классификации (до загрузки) ##

1. Apache NiFi — принимает батчи (из 1С/Excel/сканов), нормализует, регистрирует/валидирует схемы, триггерит Airflow.
2. Apache Airflow (Managed в YCloud) — оркестрирует DAG: ingest - classify - деидентификация - quality - publish.
3. Classification Service (LLM+NER + Rules) — извлекает PII/MED/PAY, присваивает теги и уверенность; выполняет MASK/MIN/TOK; при низком confidence отправляет в Quarantine.
4. Schema Drift Detector + Schema Registry — отслеживают изменения структур и версионируют схемы; сигналят стюарду для правил маршрутизации.
5. Data-Steward Console — ручная валидация спорных кейсов, настройка порогов, перезапуск DAG.

## Специальные слои в хранилище данных (Lakehouse) ##

1. S3 Landing — короткоживущее данные (можно сказать входные), всегда шифровано.
2. S3 Quarantine — спорные/непонятные батчи до ручной проверки.
3. Bronze (Сырые данные+Tags) — неизменяемый слой с проставленными тегами и минимальной очисткой.
4. Silver (Restricted) — очищенные, де-идентифицированные наборы c чувствительными полями (ограниченный доступ).
5. Silver (General) — очищенные, безопасные для широкого использования таблицы (минимизация по умолчанию).
6. Gold (Marts) — агрегаты/витрины; доступ строго через Privacy Gate.

## Метрики эффективности классификации ##

1. Precision / Recall по классам (PII, MED, PAY): калибровка порогов confidence и правил; снижение ложных срабатываний в Quarantine.
2. Coverage (% объектов с успешно присвоенными тегами): контроль слепых зон.
3. False Positive / False Negative Rate: баланс между безопасностью и пропускной способностью.
4. Schema Drift Rate (частота дрейфа): индикатор потребности в обновлении моделей/правил и схем.
5. Latency (p95/p99) classification: соблюдение SLA по батчам.
6. Throughput (GB/h, rows/s): планирование мощностей NiFi/Airflow/LLM-сервинга.
7. Manual Review Yield (% кейсов из Quarantine, подтверждённых стюардом - аналитиком компании): качество правил и порогов.
8. Tag Consistency (совпадение тегов между итерациями): стабильность работы пайплайна.
9. Использование: автоматическая подстройка порогов по F1/Precision, при всплеске дрейфа — алерты и включение обучающих задач; управление ёмкостью кластера по latency/throughput.

## Масштабирование и расширение ##

Горизонтально:

1. NiFi — кластер, распределённые очереди/партишены - в YCloud нет managed instance, придется масштабировать вручную
2. Airflow — autoscaling воркеров (KEDA/Celery), параллелизм DAG - managed YCloud instance.
3. Classification Service — stateless pods (не хотелось бы использовать kubernetes, но если придется, то можно использовать Managed instance) + автоскейлинг; кеширование токенов/словари; 
4. S3/ClickHouse — масштабирование по партициям и шардам; S3 — не узкое место, Managed Clickhouse в YCloud

## По данным и источникам ##

1. Добавление новых Processors в NiFi и новых схем в Registry; правила LLM/NER обновляются без даунтайма.
2. Quarantine-first для неизвестных схем — исключает риск некорректной публикации.

## Надёжность ##

1. Повторная обработка батчей идемпотентна (Bronze append-only, дедуп ключом).
2. Автоматические канарейки на тестовом бакете и тестовом каталоге схем.
3. Безопасность (PbD)
4. Везде шифрование (SSE-KMS), ключи/секреты в KMS/Lockbox, RBAC, аудит.
5. Доступ в Gold — только через Privacy Gate (если не развалится в preview, нужно тестировать)