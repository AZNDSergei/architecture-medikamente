## Обоснование выбора стратегии

Компания **«Медикаменте»** переходит с монолитной, локально размещённой системы (1С, Excel, файловый сервер, Exchange) на **гибридную микросервисную облачную архитектуру** (Yandex Cloud: S3, PostgreSQL, ClickHouse, Airflow, IAM).

После анализа рисков и бизнес-требований принято решение **использовать гибридный подход**, совмещающий:

- **Parallel Run** — для критически важных процессов (платежи, приём пациентов, бухгалтерия), чтобы обе системы работали параллельно, с синхронизацией данных.  
- **Branch by Abstraction** — для постепенного переноса логики и данных в новые модули (пациентский портал, API, аналитика) с использованием слоя абстракций и интеграционных шлюзов.

### Почему выбран гибридный вариант

| Принцип | Обоснование |
|----------|--------------|
| **Минимизация простоев** | Обеспечивает бесперебойную работу при миграции за счёт параллельного функционирования. |
| **Контроль качества данных** | Позволяет постепенно выравнивать структуры и схемы данных между системами. |
| **Гибкость** | Можно переносить отдельные домены независимо, не блокируя основную деятельность. |
| **Снижение технических рисков** | Branch by Abstraction даёт возможность протестировать функциональность до полного переключения. |

---

## Cutover-план миграции (гибридный сценарий)

| **Этап** | **Описание действия** | **Ключевые задачи** | **Ответственные** | **Время/Сроки** | **Риски и меры по снижению** |
|-----------|------------------------|----------------------|--------------------|------------------|-------------------------------|
| **1. Анализ и подготовка** | Оценка текущей архитектуры, данных и зависимостей. Определение доменных границ и критичных процессов. | Составить карту бизнес-процессов<br>Определить источники PII/MED<br>Подготовить модель данных<br>Согласовать архитектуру миграции | CTO/Архитектор | 2 недели | Неполный охват процессов -> провести аудит данных и зависимости; задействовать экспертов из отделов, проводить совместный риск-менеджмент с остальным техническим персоналом |
| **2. Проектирование слоя абстракций** | Создание интеграционного слоя между старой системой и новой платформой. | Разработать API-шлюз<br>Реализовать ETL-коннекторы к 1С и Excel<br>Определить адаптеры для миграции пациентов и платежей | Архитектор, Новый python dev (DAG-процессы) | 3 недели | Несовместимость форматов -> использовать временные таблицы и маппинг-схемы |
| **3. Развёртывание целевой инфраструктуры** | Настройка облачной среды: S3, PostgreSQL, ClickHouse, Airflow, IAM. | Развернуть окружения (DEV, STAGE, PROD)<br>Настроить KMS и Lockbox<br>Создать пайплайны Airflow для миграции |  Admin | 2 недели | Ошибки конфигурации -> использовать IaC (Terraform), провести dry-run |
| **4. Миграция данных (Pilot)** | Пилотная миграция части данных (пациенты, записи, медкарты). | Провести деидентификацию и нормализацию<br>Загрузить пилотный набор<br>Проверить целостность и производительность | Архитектор (и весь технический персонал) | 1 неделя | Потеря данных -> snapshot старой БД, тестовые сценарии отката |
| **5. Parallel Run (основной этап)** | Запуск обеих систем параллельно, сравнение результатов. | Настроить двустороннюю синхронизацию (S3-1C) - рассматривается Nifi <br>Проводить сверку данных<br>Обеспечить ежедневный аудит расхождений | Архитектор, админ | 4 недели | Расхождение данных -> журнал ошибок, ежедневные отчёты, ручная сверка |
| **6. Branch by Abstraction (модульный перенос)** | Пошаговый перенос функций в новую систему (портал, API, аналитика). | Разделить функциональные блоки<br>Внедрить адаптеры<br>Постепенно отключать старые модули | Архитектор, Разработчики | 6 недель | Нарушение связей -> интеграционные тесты, контроль целостности |
| **7. Тестирование и валидация** | Многоуровневое тестирование новой системы. | Unit, Integration, Load, Security тесты<br>Проверка миграции данных<br>Верификация API | Весь технический персонал (нужно рассмотреть найм QA) | 2 недели | Ошибки доступа -> RBAC-тестирование и аудит IAM |
| **8. Финальное переключение (Cutover)** | Перенос всех пользователей и данных в новую систему. | Отключить старую систему<br>Перенаправить DNS и API<br>Подтвердить успешную работу | Архитектор,  админ | 3 дня | Простои -> rollback-план, бэкап конфигураций |
| **9. Постмониторинг и стабилизация** | Контроль и оптимизация после запуска. | Мониторинг ошибок и производительности<br>Анализ логов Cloud Logging<br>Коррекция DAG и индексов | Архитектор, админ | 4 недели | Деградация -> автоалерты и SLA Dashboard |

---

## План управления рисками

| **Риск** | **Вероятность** | **Воздействие** | **Меры по снижению** | **Ответственный** |
|-----------|-----------------|------------------|----------------------|--------------------|
| Потеря данных при миграции | Средняя | Высокое | Snapshot перед миграцией, тестовые загрузки, временное наличие старых процессов (parallel-run) | CTO |
| Несогласованность данных при Parallel Run | Высокая | Среднее | Двусторонняя синхронизация + аудит расхождений | Новый Python-dev |
| Ошибки в конфигурации облака | Средняя | Высокое | Использовать скрипты (можно рассмотреть terraform) + review конфигураций | Админ |
| Отказ API лаборатории | Средняя | Среднее | Включить retry и circuit breaker | Архитектор |
| Недостаток компетенций DevOps/Cloud | Средняя | Высокое | Внутреннее обучение + ревью архитектуры CTO | CTO |
| Деградация производительности ClickHouse | Низкая | Среднее | Индексация, шардирование, настройка merge-tree | CTO |
| Нарушение доступа к PII/MED | Низкая | Высокое | RBAC + Masking + Audit IAM | Архитектор, админ |

---

## Вывод

Гибридный подход сочетает **безопасность параллельного запуска** и **гибкость поэтапного переноса функциональности**.  
Он позволяет мигрировать без прерывания бизнес-процессов, минимизируя риски потери данных и снижая нагрузку на персонал.

Ключевой успех — в **постепенной миграции по доменам**, **аудите данных** и **постоянном мониторинге производительности и безопасности**.
